<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Delta Hedging Simulation (With Frictions)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Inter, sans-serif; background:#f0f4f8; }
canvas { max-height: 300px; }
</style>
</head>

<body class="p-6 flex justify-center">
<div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-6xl">

<h1 class="text-3xl font-bold mb-6">Delta Hedging Simulation (With Frictions)</h1>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<input id="initialStockPrice" type="number" value="100" step="0.01" class="border p-2 rounded">
<input id="strikePrice" type="number" value="100" step="0.01" class="border p-2 rounded">
<input id="daysToExpiry" type="number" value="30" class="border p-2 rounded">
<input id="impliedVol" type="number" value="20" step="0.1" class="border p-2 rounded">
<input id="realizedVol" type="number" value="25" step="0.1" class="border p-2 rounded">
<input id="stockSpread" type="number" value="0.01" step="0.001" class="border p-2 rounded">
<input id="optionSpread" type="number" value="0.05" step="0.01" class="border p-2 rounded">
<input id="deltaThreshold" type="number" value="0.05" step="0.01" class="border p-2 rounded">
</div>

<button id="runBtn" class="bg-blue-600 text-white px-4 py-2 rounded mb-6">
Run Simulation
</button>

<canvas id="priceChart"></canvas>
<canvas id="plChart" class="mt-6"></canvas>

<table class="mt-6 w-full border text-sm">
<thead class="bg-gray-100">
<tr>
<th class="border p-1">Day</th>
<th class="border p-1">Stock</th>
<th class="border p-1">Option</th>
<th class="border p-1">Delta</th>
<th class="border p-1">Shares</th>
<th class="border p-1">Daily P/L</th>
<th class="border p-1">Cum P/L</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

</div>

<script>
// ---------- Normal CDF (no Math.erf) ----------
function normCDF(x) {
  const t = 1 / (1 + 0.2316419 * Math.abs(x));
  const d = 0.3989423 * Math.exp(-x * x / 2);
  let prob = d * t * (
    0.3193815 +
    t * (-0.3565638 +
    t * (1.781478 +
    t * (-1.821256 +
    t * 1.330274)))
  );
  if (x > 0) prob = 1 - prob;
  return prob;
}

// ---------- Blackâ€“Scholes ----------
function bsPrice(S,K,T,sigma){
  if(T<=0) return Math.max(0,S-K);
  let d1=(Math.log(S/K)+0.5*sigma*sigma*T)/(sigma*Math.sqrt(T));
  let d2=d1-sigma*Math.sqrt(T);
  return S*normCDF(d1)-K*normCDF(d2);
}

function bsDelta(S,K,T,sigma){
  if(T<=0) return S>K?1:0;
  let d1=(Math.log(S/K)+0.5*sigma*sigma*T)/(sigma*Math.sqrt(T));
  return normCDF(d1);
}

// ---------- Simulation ----------
let priceChart, plChart;
let volState=0;

document.getElementById("runBtn").onclick = () => {

const S0 = +document.getElementById("initialStockPrice").value;
const K = +document.getElementById("strikePrice").value;
const days = +document.getElementById("daysToExpiry").value;
const iv = +document.getElementById("impliedVol").value / 100;
const rv = +document.getElementById("realizedVol").value / 100;
const stockSpreadVal = +document.getElementById("stockSpread").value;
const optionSpreadVal = +document.getElementById("optionSpread").value;
const deltaThresh = +document.getElementById("deltaThreshold").value;

volState = rv;

let S = S0;
let T = days / 252;
let optionPrice = bsPrice(S,K,T,iv) + optionSpreadVal / 2;
let delta = bsDelta(S,K,T,iv);
let shares = -delta;
let cumPL = 0;

const rows=[];
const prices=[];
const pls=[];

for(let d=1; d<=days; d++){
  // Vol clustering
  volState = 0.9 * volState + 0.1 * rv + 0.1 * (Math.random()-0.5);
  volState = Math.max(0.01, volState);

  const z = Math.sqrt(-2*Math.log(Math.random())) * Math.cos(2*Math.PI*Math.random());
  const prevS = S;
  S = S * Math.exp(-0.5*volState*volState/252 + volState*Math.sqrt(1/252)*z);

  const Tnew = (days-d)/252;
  const optMid = bsPrice(S,K,Tnew,iv);
  const optExec = optMid - optionSpreadVal/2;

  const newDelta = bsDelta(S,K,Tnew,iv);
  const targetShares = -newDelta;

  let trade = 0;
  if (Math.abs(targetShares - shares) > deltaThresh) {
    trade = targetShares - shares;
  }

  const execPx = trade > 0 ? S + stockSpreadVal/2 : S - stockSpreadVal/2;

  const stockPL = (S - prevS) * shares;
  const optionPL = optExec - optionPrice;
  const slippage = Math.abs(trade) * S * volState * 0.001;

  const dailyPL = stockPL + optionPL - slippage;
  cumPL += dailyPL;

  shares += trade;
  optionPrice = optExec;

  rows.push({d,S,optionPrice,newDelta,shares,dailyPL,cumPL});
  prices.push(S);
  pls.push(cumPL);
}

// ---------- Render table ----------
const table = document.getElementById("table");
table.innerHTML="";
rows.forEach(r=>{
  table.innerHTML += `
  <tr>
    <td class="border p-1">${r.d}</td>
    <td class="border p-1">$${r.S.toFixed(2)}</td>
    <td class="border p-1">$${r.optionPrice.toFixed(2)}</td>
    <td class="border p-1">${r.newDelta.toFixed(3)}</td>
    <td class="border p-1">${r.shares.toFixed(3)}</td>
    <td class="border p-1 ${r.dailyPL>=0?'text-green-600':'text-red-600'}">$${r.dailyPL.toFixed(2)}</td>
    <td class="border p-1 ${r.cumPL>=0?'text-green-600':'text-red-600'}">$${r.cumPL.toFixed(2)}</td>
  </tr>`;
});

// ---------- Charts ----------
if(priceChart) priceChart.destroy();
if(plChart) plChart.destroy();

priceChart = new Chart(document.getElementById("priceChart"), {
  type: "line",
  data: { labels: rows.map(r=>r.d),
    datasets: [{ label:"Stock Price", data:prices, borderColor:"#2563eb" }]
  }
});

plChart = new Chart(document.getElementById("plChart"), {
  type: "line",
  data: { labels: rows.map(r=>r.d),
    datasets: [{ label:"Cumulative P/L", data:pls, borderColor:"#16a34a" }]
  }
});
};
</script>
</body>
</html>
